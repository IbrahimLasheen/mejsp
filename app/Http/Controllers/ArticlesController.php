<?php namespace App\Http\Controllers;use App\Models\Articles;use App\Models\ArticlesEn;use Illuminate\Http\Request;use Illuminate\Support\Facades\DB;use Illuminate\Support\Facades\Crypt;use Illuminate\Contracts\Encryption\DecryptException;use Illuminate\Support\Facades\URL;class ArticlesController extends Controller{const PATH="assets/uploads/articles-ar/";const THUMBNAILS_PATH="assets/uploads/thumbnails/articles-ar/";const IMG_EXT='.webp';public function index(){$query=null;$where=null;$equal='=';$status=isset($_GET['status'])?$_GET['status']:null;$search=isset($_GET['search'])?$_GET['search']:null;if($status=='active'){$where="status";$query="1";}elseif($status=='in-active'){$where="status";$query="0";}if(isset($_GET['search'])){$query="%".trim($_GET['search'])."%";$where='title';$equal='like';}$articles=Articles::select('title','slug','id','image','created_at','status')->where($where,$equal,$query)->orderBy("id",'DESC')->paginate(40);return view('admin.articles.all',compact("articles"));}public function create(){return view('admin.articles.create');}public function store(Request $request){$request->validate(['slug'=>'required|unique:articles_ar,slug|max:500','meta_desc'=>'required|max:1500','image'=>'required|mimes:jpeg,jpg,png,webp|max:10240','content'=>'required',"title"=>'required|max:255']);$image=$request->image;$imgName=randomName(self::IMG_EXT);$slug=slug($request->slug);$insert=Articles::create(['slug'=>$slug,'content'=>$request->content,'image'=>$imgName,'title'=>$request->title,'meta_desc'=>$request->meta_desc,'added_by'=>getAuth('admin','id'),]);if($request->show_in_chat){$insert->show_in_chat = true;$insert->save();}if($insert->save()){image($image,self::PATH,$imgName,1200,900);image($image,self::THUMBNAILS_PATH,$imgName,400,400);return response(['status'=>true,'message'=>'تم اضافة المقالة بنجاح','form'=>'reset']);}}public function edit($id){$row=Articles::where('id',$id)->first();if(!empty($row)){return view('admin.articles.edit',compact('row'));}else{return redirect(adminUrl('articles'));}}public function update(Request $request){$id=$request->id;$row=Articles::where("id",$id)->first();if(!empty($row)){$request->validate(['slug'=>'required|unique:articles_ar,slug,'.$id.'|max:500','meta_desc'=>'required|max:1500','image'=>'nullable|mimes:jpeg,jpg,png,webp|max:10240','content'=>'required',"title"=>'required|max:255']);$row->slug=slug($request->slug);$row->content=$request->content;$row->title=$request->title;$row->show_in_chat =$request->show_in_chat ? true : false;$row->meta_desc=$request->meta_desc;if($request->hasFile('image')){@unlink(self::PATH.$row->image);@unlink(self::THUMBNAILS_PATH.$row->image);$imgName=randomName(self::IMG_EXT);$row->image=$imgName;$image=$request->image;}if($row->save()){if($request->hasFile('image')){image($image,self::PATH,$imgName,1200,900);image($image,self::THUMBNAILS_PATH,$imgName,400,400);}return response(['status'=>true,'message'=>'تم تحديث المقالة بنجاح',]);}}else{return response(['status'=>"notfound",'message'=>'لم تعد هذة المقالة متاحة']);}}public function status(Request $request){try{$id=Crypt::decryptString($request->id);$row=Articles::find($id);if(!empty($row)){$row->status=$row->status=="1"?"0":"1";$row->save();$request->session()->flash('statusMsg','تم تحديث حالة المقالة بنجاح');}else{return back();}}catch(DecryptException $e){return back();}}public function destroy(Request $request){try{$id=Crypt::decryptString($request->id);$row=Articles::find($id);if(!empty($row)){@unlink(self::PATH.$row->image);@unlink(self::THUMBNAILS_PATH.$row->image);$row->delete();$request->session()->flash('statusMsg','تم حذف المقالة بنجاح');}}catch(DecryptException $e){return back();}return back();}public function old_article(){$id=isset($_GET['id'])?intval($_GET['id']):NULL;$lang=isset($_GET['lang'])?$_GET['lang']:NULL;if($id==NULL){return redirect("blog");}if($lang=='ar'){$articles=new Articles;$view="main.blog.show";}elseif($lang=='en'){$articles=new ArticlesEn;$view="main.blog-en.show";}else{return redirect("blog");}$row=DB::table($articles->table)->select('title','slug','content','image','meta_desc','id','version')->where("id",$id)->where('status',1)->first();if(empty($row->version)){return redirect("blog");}if($row->version=='new'){return redirect("blog");}$prev_id=DB::table($articles->table)->where("id",'<',$row->id)->where('status',1)->max('id');$prev=DB::table($articles->table)->select("title",'slug','image','version','id')->where("id",$prev_id)->first('id');$next_id=DB::table($articles->table)->where("id",'>',$row->id)->where('status',1)->min('id');$next=DB::table($articles->table)->select("title",'slug','image','version','id')->where("id",$next_id)->first('id');$latestArticles=DB::table($articles->table)->select("title",'slug','image','version','id')->where('status',1)->orderBy("id","DESC")->limit(5)->get();$url=url('blog-single.php').'?lang='.$lang.'&id='.$row->id.'&name='.$row->title;return view($view,compact('row','prev','next','latestArticles','url'));}public function blog(){$query=null;$where=null;$equal='=';if(isset($_GET['search'])){$query="%".trim($_GET['search'])."%";$where='title';$equal='like';}$articles=Articles::select('title','meta_desc','slug','version','id','image','status','version')->where("status",1)->where($where,$equal,$query)->orderBy("id","DESC")->paginate(70);return view('main.blog.all',compact('articles'));}public function show(Articles $articles,$slug){$row=DB::table($articles->table)->select('title','slug','content','image','meta_desc','id','version')->where("slug",$slug)->where('status',1)->first();if(!empty($row)){if($row->version=='old'){return redirect("blog");}$prev_id=DB::table($articles->table)->where("id",'<',$row->id)->where('status',1)->max('id');$prev=DB::table($articles->table)->select("title",'slug','image','version','id')->where("id",$prev_id)->first('id');$next_id=DB::table($articles->table)->where("id",'>',$row->id)->where('status',1)->min('id');$next=DB::table($articles->table)->select("title",'slug','image','version','id')->where("id",$next_id)->first('id');$latestArticles=DB::table($articles->table)->select("title",'slug','image','version','id')->where('status',1)->orderBy("id","DESC")->limit(5)->get();$url=URL::current();return view('main.blog.show',compact('row','prev','next','latestArticles','url'));}else{return redirect('blog');}}}