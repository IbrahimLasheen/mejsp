<?php namespace App\Http\Controllers;use App\Models\InternationalJournals;use App\Models\InternationalSpecialties;use App\Models\InternationalTypes;use Illuminate\Http\Request;class InternationalJournalsController extends Controller{const PATH="assets/uploads/international-journals/";const IMG_EXT='.webp';private function rules($request,$type=['store','update']){$ids=InternationalSpecialties::select('id')->get();$array_id=[];foreach($ids as $row){array_push($array_id,$row->id);}$checkField=$type=="update"?"nullable":"required";$request->validate(['specialty'=>$checkField."|in:".implode(",",$array_id),'name'=>$checkField.'|max:255','price'=>$checkField.'|numeric|digits_between:2,8','logo'=>'nullable|mimes:jpeg,jpg,png,webp|max:10240',]);}public function index(){$pageTitle='مجلات النشر الدولي';$types=InternationalTypes::orderBy("id",'DESC')->get();$journals=InternationalJournals::orderBy("id",'DESC')->get();$specialties=InternationalSpecialties::orderBy("id",'DESC')->get();$formUrl=adminUrl('international-publishing/journals/store');$btnText='اضافة المجلة';$id=isset($_GET['id'])?intval($_GET['id']):NULL;$row=NULL;if($id!=NULL){$row=InternationalJournals::with('specialty')->where('id',$id)->first();if(empty($row)){return redirect(adminPrefix().'/international-publishing/journals');}else{$formUrl=adminUrl('international-publishing/journals/update');$btnText='تحديث';}}return view("admin.international-journals.index",compact('journals','pageTitle','specialties','formUrl','btnText','row','types'));}public function store(Request $request){$this->rules($request);$logoName=NULL;if($request->hasFile('logo')){$logoName=randomName(self::IMG_EXT);}$insert=InternationalJournals::create(['specialty_id'=>$request->specialty,'name'=>$request->name,'price'=>$request->price,'logo'=>$logoName,]);if($insert->save()){if($request->hasFile('logo')){image($request->logo,self::PATH,$logoName,128,128);}return response(['status'=>true,'message'=>'تم اضافة البيانات بنجاح','form'=>'reset',]);}}public function update(Request $request){$id=$request->id;$row=InternationalJournals::find($id);if(!empty($row)){$this->rules($request,'update');$logoName=$row->logo;if($request->hasFile('logo')){$logoName=randomName(self::IMG_EXT);@unlink(self::PATH.$row->logo);}$row->specialty_id=$request->specialty;$row->name=$request->name;$row->price=$request->price;$row->logo=$logoName;if($row->save()){if($request->hasFile('logo')){image($request->logo,self::PATH,$logoName,128,128);}return response(['status'=>true,'message'=>'تم تحديث البيانات بنجاح']);}}}public function destroy(Request $request){$row=InternationalJournals::find($request->id);if(!empty($row)){@unlink(self::PATH.$row->logo);$row->delete();$request->session()->flash('success','تم حذف البيانات بنجاح');return back();}return back();}public function get_jorunals_api($id){$rows=InternationalJournals::select('id','name')->where("specialty_id",$id)->orderBy('id','DESC')->get();return json_decode($rows);}public function get_jorunals_price_api($id){$row=InternationalJournals::select('price')->where("id",$id)->first();return json_decode($row);}}